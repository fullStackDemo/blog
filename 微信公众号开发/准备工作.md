### 前期准备工作

[TOC]

#### 1、开启公众号开发者模式

##### 1.1 申请公众号

微信的开发者文档真的有点丈二和尚摸不着头脑，有点让人迷糊。

做微信公众号开发，先注册微信公众号，最好有一个**服务器**和一个**备过案的域名**，不然很多jsapi接口无法调试。

一般情况下，个人注册订阅号，企业注册企业号。

![1558671667657](assets/1558671667657.png)



##### 2.2 开发者配置

公众平台官网登录之后，找到“`基本配置`”菜单栏

![1558675543633](assets/1558675543633.png)

这里的服务器配置，是*微信*发请求到你所填写的`服务器地址`去验证你是这个==公众号==的开发者的。

> url填写：`http://外网IP`。外网IP。嗯嗯http的端口号固定使用80，不可填写其他。

> Token：自主设置，这个token与公众平台wiki中常提的*access_token*不是一回事。这个token只用于验证开发者服务器。
>
> 消息加解密密钥随机生成即可
>
> 消息加密模式，开发环境选择明文即可

如果服务器端没有，提交肯定提示失败，或者出现错误。

我是自己有个域名，然后用`Nodejs + Expres`写了一个接口：

> api/auth.js

```javascript
// 第一步认证为开发者
const crypto = require('crypto');
const config = require('../config');


// 微信认证开发者  微信服务器发送请求到你的服务器，做校验，参数都是微信传过来的。
module.exports = auth = (req, res) => {

  //1.获取微信服务器Get请求的参数 signature、timestamp、nonce、echostr
  var signature = req.query.signature,//微信加密签名
    timestamp = req.query.timestamp,//时间戳
    nonce = req.query.nonce,//随机数
    echostr = req.query.echostr;//随机字符串

  //2.将token、timestamp、nonce三个参数进行字典序排序
  // 这里的 config.token 就是上面你自定义的 Token (如：beip***6666)
  var array = [config.token, timestamp, nonce];
  array.sort();

  //3.将三个参数字符串拼接成一个字符串进行sha1加密
  var tempStr = array.join('');
  const hashCode = crypto.createHash('sha1'); //创建加密类型 
  var resultCode = hashCode.update(tempStr, 'utf8').digest('hex'); //对传入的字符串进行加密

  //4.开发者获得加密后的字符串可与signature对比，标识该请求来源于微信
  if (resultCode === signature) {
    res.send(echostr);
  } else {
    res.send('mismatch');
  }
};
```

> 使用Express搭建你的restfull api服务
>
> app.js

```javascript
const express = require('express');
const api = require('./api');
const path = require('path');
const app = express();
const port = 3000;

// 这里就是你的认证路由
app.get('/', (req, res) => {
  api.auth(req, res);
});

// listen
app.listen(port, () => {
  console.log(`Server started on localhost:%d`, port);
});
```

一般你要把你的Node项目升级到你的服务器；

其实就是当做服务器和你的电脑一样就行了，一样要先装一个`nodejs`(如果不会，可以参考之前的教程，[Node项目线上部署](../CentOs配置/Node项目线上部署.md)), 然后一样启动就行了，比如:

```javascript
node app.js
```
这样就启动你项目，`http://你的外网ip:3000`;

不过微信规定端口必须是80，如果上一步你的port 可以设置80最好，如果不可以的，只能考虑用 Nginx 走下反向代理。

假设以上问题都解决了。

访问 `http://你的外网ip`，如果浏览器打印了`mismatch`，说明这个路由走通了

这时候你再回到服务器设置这里，点击按钮，就会提示成功。

那么恭喜你，开始了万里长征的第一步。